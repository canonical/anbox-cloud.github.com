<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>anbox-platform-sdk: Creating a Platform Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">anbox-platform-sdk
   &#160;<span id="projectnumber">1.26.0</span>
   </div>
   <div id="projectbrief">Anbox Platform SDK API documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('creating_a_platform_plugin.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Creating a Platform Plugin </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Anbox loads an external platform plugin through its internal platform integration. A platform plugin is always in the form of a dynamic library that is loaded by Anbox at runtime. Whenever loading a plugin, Anbox will go through the following steps to verify if the platform plugin is installed properly and implements the standards-compliant API.</p><ol type="1">
<li>Verify existence of the platform plugin<br  />
 Anbox looks for existing platforms in the directory path<br  />
 <em>/usr/lib/&lt;target_triple&gt;/anbox/platforms/&lt;plugin_name&gt;</em> <br  />
 The plugin shared library (.so) and all its dependencies which are not part of the base OS must be installed there.</li>
<li>Verify the platform specifies a correct plugin descriptor<br  />
 Anbox retrieves the platform plugin basic information from the given share file, such as the platform name or vendor. More importantly, the provided descriptor is used to check if the SDK API version the plugin specifies what Anbox requires.</li>
<li>Verify all mandatory functions are exported<br  />
 Anbox examines if all required symbols are exported by the plugin.</li>
</ol>
<p>If a platform fails verification, Anbox refuses to load it and will terminate with an error.</p>
<p>This page walks through how to create a platform plugin step-by-step. It's highly recommanded to review the <a class="el" href="anbox_sdk_examples.html">examples</a> before proceeding.</p>
<h1><a class="anchor" id="preparation"></a>
Preparation</h1>
<p>The first requirement is to set up a proper development environment. In order to easily integrate the platform plugin into Anbox and avoid any ABI issues, the only available development environment is Ubuntu 18.04(64-bit). Using any other Ubuntu distributions is not recommended. Ubuntu 18.04 can be obtained from <a href="http://releases.ubuntu.com/18.04/">here</a>.<br  />
The following build dependencies are needed to use the SDK. </p><div class="fragment"><div class="line">$ sudo apt install build-essential cmake cmake-extras google-mock pkg-config \</div>
<div class="line">  libavcodec-dev libavformat-dev libelf-dev zlib1g-dev libegl1-mesa-dev</div>
</div><!-- fragment --><h1><a class="anchor" id="create_platform_plugin"></a>
Create a CMake-based plugin project</h1>
<p>The easiest way to build a plugin is to use the CMake (<a href="https://cmake.org/">https://cmake.org/</a>) build system for the plugin. A CMakeLists.txt file should be created and placed in the project root directory. In the plugin's CMakeLists.txt file, the SDK can be imported directly using <code>find_package</code> and setting the <code>CMAKE_PREFIX_PATH</code> to include a path to the SDK. Then the following target is imported and available to the rest of the cmake build process:</p><ul>
<li><code>anbox-platform-sdk-internal</code> - the SDK's interface library that must be linked against</li>
</ul>
<p>The following is an example CMakeLists.txt which can be used to compile a plugin:</p>
<div class="fragment"><div class="line">project(PLUGIN_PROJECT)</div>
<div class="line">cmake_minimum_required(VERSION 3.10.2)</div>
<div class="line"> </div>
<div class="line">include(CTest)</div>
<div class="line">enable_testing()</div>
<div class="line"> </div>
<div class="line">include(GNUInstallDirs)</div>
<div class="line"> </div>
<div class="line">if (NOT CMAKE_BUILD_TYPE)</div>
<div class="line">    message(STATUS &quot;No build type selected, default to release&quot;)</div>
<div class="line">    set(CMAKE_BUILD_TYPE &quot;release&quot;)</div>
<div class="line">endif()</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Load the anbox-sdk cmake package</span></div>
<div class="line">find_package(<a class="code" href="namespaceanbox.html">anbox</a>-platform-sdk REQUIRED)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Set platform plugin name. Please replace it with yours plugin name.</span></div>
<div class="line">set(PLATFORM_PLUGIN_NAME <span class="stringliteral">&quot;my-plugin&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># The path to platform plugin installation in Anbox</span></div>
<div class="line">set(PLATFORM_INSTALL_DIR ${CMAKE_INSTALL_LIBDIR}/<a class="code" href="namespaceanbox.html">anbox</a>/platforms/${PLATFORM_PLUGIN_NAME})</div>
<div class="line">set(CMAKE_CXX_FLAGS <span class="stringliteral">&quot;${CMAKE_CXX_FLAGS} -DPLATFORM_INSTALL_DIR=\\\&quot;${CMAKE_INSTALL_PREFIX}/${PLATFORM_INSTALL_DIR}\\\&quot;&quot;</span>)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Add the plugin target</span></div>
<div class="line">set(PLUGIN_SOURCES ${PLATFORM_PLUGIN_NAME}_platform.cpp)</div>
<div class="line">add_library(AnboxPlatformPlugin</div>
<div class="line">  SHARED ${PLUGIN_SOURCES})</div>
<div class="line"> </div>
<div class="line"># Link against the <a class="code" href="namespaceanbox.html">anbox</a>-platform-sdk-<span class="keyword">internal</span> library</div>
<div class="line">target_link_libraries(AnboxPlatformPlugin PUBLIC</div>
<div class="line">  <a class="code" href="namespaceanbox.html">anbox</a>-platform-sdk-<span class="keyword">internal</span>)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># All platforms need to follow the naming scheme platform_&lt;name&gt;.so</span></div>
<div class="line">set_target_properties(</div>
<div class="line">  AnboxPlatformPlugin PROPERTIES</div>
<div class="line">  OUTPUT_NAME platform_${PLATFORM_PLUGIN_NAME}</div>
<div class="line">  PREFIX <span class="stringliteral">&quot;&quot;</span></div>
<div class="line">  COMPILE_FLAGS <span class="stringliteral">&quot;-std=c++14&quot;</span></div>
<div class="line">  SUFFIX <span class="stringliteral">&quot;.so&quot;</span></div>
<div class="line">  INSTALL_RPATH <span class="stringliteral">&quot;${CMAKE_INSTALL_PREFIX}/${PLATFORM_INSTALL_DIR}&quot;</span>)</div>
<div class="line"> </div>
<div class="line"># Run the validation test suites against the platform implementation</div>
<div class="line"># <span class="keyword">using</span> the <a class="code" href="namespaceanbox.html">anbox</a>-platform-tester executable from the sdk</div>
<div class="line"># For all production ready platform plugin, all tests need to pass.</div>
<div class="line">add_test(NAME CustomPlatformValidation</div>
<div class="line">         COMMAND ${ANBOX_PLATFORM_TESTER} ${CMAKE_CURRENT_BINARY_DIR}/platform_${PLATFORM_PLUGIN_NAME}.so)</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor"># Install the platform plugin to the proper location in Anbox.</span></div>
<div class="line">install(</div>
<div class="line">  TARGETS AnboxPlatformPlugin</div>
<div class="line">  LIBRARY DESTINATION ${PLATFORM_INSTALL_DIR}</div>
<div class="line">)</div>
<div class="ttc" id="anamespaceanbox_html"><div class="ttname"><a href="namespaceanbox.html">anbox</a></div><div class="ttdef"><b>Definition:</b> <a href="anbox__proxy_8h_source.html#l00065">anbox_proxy.h:65</a></div></div>
</div><!-- fragment --><p>A source file named <code>&lt;plugin_name&gt;_platform.cpp</code> is expected to reside in the project's root directory, alongside CMakeLists.txt. Below is how a platform plugin project layout looks like. </p><div class="fragment"><div class="line">~/project_plugin$ tree</div>
<div class="line">.</div>
<div class="line">├── CMakeLists.txt</div>
<div class="line">└── project_platform.cpp</div>
</div><!-- fragment --><p> This is the minimum required to start building an Anbox platform plugin. The example <a class="el" href="anbox_sdk_example_minimal.html">minimal platform</a> provides a skeleton of raw platform plugin implementation that may be copied and modified for quicker development.</p>
<h1><a class="anchor" id="build_platform_plugin"></a>
Build your platform plugin</h1>
<p>As is shown in the CMakeLists.txt above, you have to specify <code>CMAKE_PREFIX_PATH</code> configuration setting where the Anbox Platform SDK is located via the CMake command-line interface. With it, CMake can easily find and include the SDK's interface library, header files and testing tool targets. You can run the following commands to build your plugin from the plugin's root directory. </p><div class="fragment"><div class="line">$ cmake ./ -Bbuild -DCMAKE_PREFIX_PATH=&lt;<a class="code" href="namespaceanbox.html">anbox</a>-platform-sdk-path&gt;</div>
<div class="line">$ cd build</div>
<div class="line">$ make -j$(nproc)</div>
</div><!-- fragment --><h1><a class="anchor" id="test_platform_plugin"></a>
Test your platform plugin</h1>
<p>The SDK supplies a tool called <code>anbox-platform-tester</code> which allows validation of platform plugin implementation. The <code>anbox-platform-tester</code> performs various tests to ensure the plugin is correctly implemented and behaves the way Anbox expect it to behave.<br  />
A platform plugin dynamic library can be tested with the <code>anbox-platform-tester</code> like this:</p>
<div class="fragment"><div class="line">$ &lt;path to <a class="code" href="namespaceanbox.html">anbox</a> platform sdk&gt;/bin/<a class="code" href="namespaceanbox.html">anbox</a>-platform-tester &lt;path to plugin&gt;/platform_&lt;platform name&gt;.so</div>
</div><!-- fragment --><p>or simply run <code>make test</code> in the build directory. </p><div class="fragment"><div class="line">$ CTEST_OUTPUT_ON_FAILURE=1 make &amp;&amp; make test</div>
</div><!-- fragment --><p>The platform tester will print out a detailed report of the test results.</p>
<p><b>Note:</b> A production ready platform plugin needs to pass all test cases without exceptions. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
